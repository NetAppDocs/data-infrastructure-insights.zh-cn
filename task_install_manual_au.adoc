---
sidebar: sidebar 
permalink: task_install_manual_au.html 
keywords: Acquisition Unit, AU, install, configure, Linux, add, remove, uninstall, delete, deleting, move, moving, manual, AU, Patch 
summary: 可以将Data Infrastructure Insights配置为手动更新 AU 软件，从而更好地控制安装在租户上的软件。 
---
= 手动安装采集单元软件
:hardbreaks:
:allow-uri-read: 


[role="lead"]
默认情况下，Data Infrastructure Insights在部署更新时自动更新采集单元 (AU) 软件。然而，在安全受控的环境中，自动更新可能无法实现或不需要。在这些情况下，可以配置Data Infrastructure Insights以手动更新 AU 软件，从而对租户上安装的软件进行更好的控制。

要手动下载并安装 AU 软件，请执行以下步骤。Data Infrastructure Insights提供了一个有用的 Swagger 文档页面，您可以使用它来执行其中的许多步骤，也可以使用您自己的 API 脚本/命令。转到管理 > API 访问并单击“API 文档”链接。

Linux 和 Windows 的流程类似。



== 在 Linux 上执行新的 AU 安装：

. 在Data Infrastructure Insights中，创建一个 API 令牌。
+
.. 导航到 *管理 > API 访问* 并选择 *+API 访问令牌*。
+
... 设置易于识别的*名称*和*描述*
... 类型：选择*采集单元*和*数据收集*
... 权限：*读/写*
... 选择所需的“到期”和“自动续订”值


.. 点击“保存”
.. 复制生成的 API 访问令牌。必须先执行此步骤才能关闭窗口。




image:Manual_AU_Create_API_Token.png["创建 API 令牌"]

. 在 Swagger（管理 > API 访问 > API 文档）中，使用令牌授权Data Infrastructure InsightsAPI
+
.. 单击 Swagger 屏幕右上角的“授权”
.. 将上面复制的令牌粘贴到客户 APIKey 字段
.. 点击“授权”
.. 关闭窗口




image:Manual_AU_Authorization.png["授权 API 令牌"]

. 使用 _/au/installers/{platform}/latest_ 或 _/au/installers/{platform}/{version}_ API 下载 AU 安装程序：
+
.. 平台：*linux*
.. 版本：*<version>*（最新或指定）




image:Manual_AU_API_Retrieve_latest.png["用于检索最新 AU 版本的 API"]


NOTE: 如果您没有下载最新版本，请与NetApp确认要下载的 AU 版本。

. 单击“*下载文件*”。如果您在 AU 系统以外的系统上执行这些步骤，请将下载的文件复制到 AU 系统。
. 或者，您可以在 AU 系统上运行生成的 CURL 命令：
+
 curl -X GET "<tenant>/rest/v1/au/installers/linux/<AU version>" -H "accept: application/octet-stream" -H "X-CloudInsights-ApiKey: <token>"
. 此时，安装程序文件应该出现在 AU 系统上。



IMPORTANT: 接下来的步骤需要使用临时令牌。不要使用您上面创建的 API 访问令牌。

. 在Data Infrastructure InsightsAPI Swagger 中，使用 _/au/oneTimeToken_ API 创建一次性令牌。
+
.. 复制生成的一次性令牌。




image:Manual_AU_one_time_token.png["创建一次性 API 令牌"] image:Manual_AU_one_time_token_response.png["一次性 API 令牌示例的响应"]

. 在要安装 AU 的机器上，导航到包含下载的安装程序文件的文件夹。以下命令要求用户具有 root 权限。
+
.. 解压缩安装程序文件
.. 将目录更改为生成的安装程序文件夹
.. 通过执行以下操作将一次性令牌和安装程序版本导出到环境变量：
+
 export TOKEN=<One-Time Token>
.. 运行以下命令以使用自定义用户和组安装 CI：
+
 ./cloudinsights-install.sh <custom user> <custom group>
+
注意：如果您不想使用自定义用户和组，则可以使用默认的“cisys”用户和组。在这种情况下，运行上面的安装命令但不要指定用户和组。





此时，AU 软件已安装在系统上，并且自定义用户和组可以访问。但是，您无法添加数据收集器。要手动执行此操作，请阅读以下说明。如果您只想安装补丁，请参阅<<downloading-a-patch,修补程序>>下面的部分。



== 手动安装数据收集器

使用 /collector/patch/datasourceswar/latest API 下载最新的 datasources.war：

image:API_Manual_Download_datasources.png["用于检索最新 datasources.war 的 API"]

注意：如果您没有下载最新版本，请与NetApp确认要指定下载的版本。

单击“下载文件”。如果您在 AU 系统以外的系统上执行这些步骤，请将下载的 datasources.war zip 包复制到 AU 系统。

确保将 datasources.war zip 包复制到以下目录：/var/lib/netapp/cloudinsights/acq/download

导航到 /var/lib/netapp/cloudinsights/acq/download 目录以查找 datasources.war 并验证那里的 zip 文件：

. 您必须切换到自定义用户（或注销 root 用户并使用其登录）才能执行下一步。
+
 su <custom user>
+
注意：如果您使用默认的“cisys”用户和组，则无需执行此步骤。

+
注意：自定义用户可以是您在 AU 安装期间提供给 cloudinsights-install.sh 的自定义组成员的任何用户，并且可以与您在 AU 安装期间提供的自定义用户相同或不同。

. 执行以下操作：
+
....
chmod 770 /var/lib/netapp/cloudinsights/acq/download/datasources-war-<version>.zip
ls -al /var/lib/netapp/cloudinsights/acq/download
…
drwxrwx--- 2 test-user2 test-group-1  4096 Feb 16 10:10 datasources-war-<version>.zip
…
....
+
注意：如果使用“cisys”用户和组，它们将显示在上面的输出中。

+
注意：如果您计划使用不同的自定义用户进行安装，请确保所有者和组的组权限都设置为读写（chmod 660...）

. 重新启动 AU。在Data Infrastructure Insights中，导航到可观察性>收集器并选择采集单元选项卡。从 AU 右侧的“三个点”菜单中选择重新启动。




== 下载补丁

使用 /collector/patch/file/{version} API 下载补丁：

image:API_Manual_Download_patch.png["用于检索补丁的 API"]

注意：请与NetApp确认要下载的指定版本。

单击“下载文件”。如果您在 AU 系统以外的系统上执行这些步骤，请将下载的补丁 zip 包复制到 AU 系统。

确保将补丁 zip 包复制到以下目录：/var/lib/netapp/cloudinsights/acq/download

导航到补丁的 /var/lib/netapp/cloudinsights/acq/download 目录并验证那里的 .zip 文件：

. 您必须切换到自定义用户（或注销 root 用户并使用其登录）才能执行下一步。
+
 su <custom user>
+
注意：如果您使用默认的“cisys”用户和组，则无需执行此步骤。

+
注意：自定义用户可以是您在 AU 安装期间提供给 cloudinsights-install.sh 的自定义组成员的任何用户，并且可以与您在 AU 安装期间提供的自定义用户相同或不同。

. 执行以下操作：
+
....
chmod 770 /var/lib/netapp/cloudinsights/acq/download/<patch_file_name>.zip
ls -al /var/lib/netapp/cloudinsights/acq/download
…
drwxrwx--- 2 test-user2 test-group-1  4096 Feb 16 10:10 <patch_file_name>.zip
…
....
+
注意：如果使用“cisys”用户和组，它们将显示在上面的输出中。

+
注意：如果您计划使用不同的自定义用户进行安装，请确保所有者和组的组权限都设置为读写（chmod 660...）

. 重新启动 AU。在Data Infrastructure Insights中，导航到可观察性>收集器并选择采集单元选项卡。从 AU 右侧的“三个点”菜单中选择重新启动。




== 外部密钥检索

如果您提供 UNIX shell 脚本，则获取单元可以执行该脚本从您的密钥管理系统中检索 *私钥* 和 *公钥*。

为了检索密钥， Data Infrastructure Insights将执行脚本，并传递两个参数：_key id_ 和 _key type_。  _Key id_ 可用于识别密钥管理系统中的密钥。 _密钥类型_可以是“公共”或“私人”。当密钥类型为“公共”时，脚本必须返回公钥。当密钥类型为“private”时，必须返回私钥。

要将密钥发送回采集单元，脚本必须将密钥打印到标准输出。脚本必须仅将密钥打印到标准输出；不得将任何其他文本打印到标准输出。一旦请求的键被打印到标准输出，脚本必须以退出代码 0 退出；任何其他返回代码都被视为错误。

该脚本必须使用 SecurityAdmin 工具向采集单元注册，该工具将与采集单元一起执行该脚本。该脚本必须具有 root 和“cisys”用户的_read_和_execute_权限。如果注册后shell脚本被修改，则必须将修改后的shell脚本重新向采集单位注册。

|===


| 输入参数：密钥ID | 密钥标识符用于在客户密钥管理系统中识别密钥。 


| 输入参数：密钥类型 | 公共或私人。 


| 输出 | 必须将请求的密钥打印到标准输出。目前支持 2048 位 RSA 密钥。密钥必须按照以下格式进行编码和打印 - 私钥格式 - PEM、DER 编码的 PKCS8 PrivateKeyInfo RFC 5958 公钥格式 - PEM、DER 编码的 X.509 SubjectPublicKeyInfo RFC 5280 


| 退出代码 | 退出代码为零表示成功。所有其他退出值均被视为失败。 


| 脚本权限 | 脚本必须具有 root 和“cisys”用户的读取和执行权限。 


| logs | 脚本执行被记录。日志可以在以下位置找到 - /var/log/netapp/cloudinsights/securityadmin/securityadmin.log /var/log/netapp/cloudinsights/acq/acq.log 
|===